<!DOCTYPE html>

<html lang="he" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>page 5</title>
    <link id="pagestyle" rel="stylesheet" href="css/styles.css" type="text/css" />
    <script src="js/jquery-3.2.1.min.js" charset="utf-8"></script>
    <script src="js/scripts.js" charset="utf-8"></script>
    <script>

          function pickCSS() {
            var pickLang = localStorage.getItem("langID");
            if (typeof pickLang !== 'undefined' && pickLang !== null) {
                if (pickLang.localeCompare("he") === 0) {
                    swapStyleSheet('css/styles.css');
                    localStorage.setItem("langID", "he");
                    loadLang();
                } else if (pickLang.localeCompare("en") === 0) {
                    localStorage.setItem("langID", "en");
                    swapStyleSheet('css/styles-eng.css');
                    loadLang();
                }
            } else {
                localStorage.setItem("langID", "he");
                swapStyleSheet('css/styles.css');
                loadLang();
            }
        }
        function loadLang() {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
        if (this.readyState === 4 && this.status === 200) {
            var myObj = JSON.parse(this.responseText);
            var pickLang = localStorage.getItem("langID");
            if (typeof pickLang !== 'undefined' && pickLang !== null) {
                if (pickLang.localeCompare("he") === 0) {
                    localStorage.setItem("langID", "he");
                    $('#lang').css("background-image", "url('cut/Group 128.png')");
                    localStorage.setItem("lang", JSON.stringify(myObj.HE));
                } else {
                    localStorage.setItem("langID", "en");
                    $('#lang').css("background-image", "url('cut/Group 312.png')");
                    localStorage.setItem("lang", JSON.stringify(myObj.EN));
                }
            } else {
                localStorage.setItem("langID", "he");
                localStorage.setItem("lang", JSON.stringify(myObj.HE));
            }
             loadAndFill();
        }
    };
    xmlhttp.open("GET", "js/lang.json", true);
    xmlhttp.send();
 }

     function pickLanguage() {
            var pickLang = localStorage.getItem("langID");
            if (typeof pickLang !== 'undefined' && pickLang !== null) {
                if (pickLang.localeCompare("he") === 0) {
                    localStorage.setItem("langID", "en");
                    pickCSS();

                } else if (pickLang.localeCompare("en") === 0) {
                    localStorage.setItem("langID", "he");
                    pickCSS();
                  }
            } else {
                localStorage.setItem("langID", "he");
                pickCSS();
            }
        }
        
        async function personSearh() {
            var valueIs = $('#search').val();
            console.log(valueIs);
            var object = await searchPerson(valueIs);
            console.log(object);
            counter = 0;
             $('#col1, #col2').empty();
            for (var i in object) {
                var idIs=object[i].id;
                subObj = object[i].translations;
                for (var j in subObj) {
                    if (subObj[j]["language"].indexOf(langIs) > -1) {
                            var col = addToColumn();
                        counter++;
                        var elem = '<span id=' + 'itm' + counter + ' class="colItem"  onclick="getMoreInfo(this.id)"  data=' +  idIs + '>' + subObj[j].first_name + " " + subObj[j].last_name + '</span>';
                            document.getElementById(col).innerHTML += elem;
                        
                    }
                }
            }

            var table = document.getElementById("col1");
            height=table.offsetHeight +30;
            $('#splitCol').css("height", height);
        }


        function loadAndFill(){
            JsonLang = localStorage.getItem("lang");
            var lang = JSON.parse(JsonLang);
            $('#hdTitle').text(lang["hdTitles"]["starsJour"]);
            $('#search').attr("placeholder", lang["search"]["sj"]);
            $('#catgTitle').text(lang.catgTitle);
            fillColumns();
        }

        function addToColumn() {
            var c1 = document.getElementById("col1").childElementCount;
            var c2 = document.getElementById("col2").childElementCount;
            if (c1 > c2) {
                return 'col2';
            } else {
                return 'col1';
            }
        }

        function fillColumns() {
            JsonLang = localStorage.getItem("lang");
            var lang = JSON.parse(JsonLang);
            var item = JSON.parse(localStorage.getItem('my_item_back'));
            console.log(`item is ${item}`);
            if (typeof item !== 'undefined' && item !== null) {
                console.log('item back');
                var main = item.main
                var sub = item.sub;
                catg = lang.categories[main];
                catgFilter = lang.filterCatg[main];
                $('#catgMain').html(catg.title);
                if (sub.localeCompare("") !== 0) {
                    subCatg = catg["subCat"][sub];
                    subCatgFilter = catgFilter["subCat"][sub];
                    $('#catgSub,#split1,#split2').css("display", "inline-block");
                    $('#catgSub').html(subCatg);
                    findMatchesSub(subCatgFilter);
                } else {
                    $('#split1').css("display", "inline-block");
                    $('#split2,#catgSub').css("display", "none");
                    $('#catgMain').addClass('greenTitle');
                    findMatchesCatg(catgFilter.title);
                }
            } else {
                var main =  sessionStorage.getItem("main");
                var sub = sessionStorage.getItem("sub");
                console.log(main + " --- " + sub);
                catg = lang.categories[main];
                catgFilter = lang.filterCatg[main];
                $('#catgMain').html(catg.title);
                if (sub.localeCompare("") !== 0) {
                    subCatg = catg["subCat"][sub];
                    subCatgFilter = catgFilter["subCat"][sub];
                    $('#catgSub,#split1,#split2').css("display", "inline-block");
                    $('#catgMain').html(catg.title);
                    $('#catgSub').html(subCatg);
                    findMatchesSub(subCatgFilter);
                } else {
                    $('#split1').css("display", "inline-block");
                    $('#split2').css("display", "none");
                    $('#catgMain').addClass('greenTitle');
                    findMatchesCatg(catgFilter.title);
                }
            }
        }

       async function findMatchesSub(searchValue) {
            langIs = localStorage.getItem("langID");
           $('#col1, #col2').empty();
           object = await getSubCategory(searchValue);
           console.log(object);
           var counter = 0;
           $('#col1, #col2').empty();

           for (var i in object) {
               var idIs = object[i].id;
                 subObj = object[i].translations;
                for (var j in subObj) {
                    if (subObj[j]["language"].indexOf(langIs) > -1) {
                        counter = counter + 1;
                        var col = addToColumn();
                        var elem = '<span id=' + 'itm' + counter + ' onclick="getMoreInfo(this.id)"  class="colItem" data=' + idIs + '>' + subObj[j].first_name + " " + subObj[j].last_name + '</span>';
                        document.getElementById(col).innerHTML += elem;
                    }
                }
               }
            var table = document.getElementById("col1");
            height=table.offsetHeight +30;
            $('#splitCol').css("height", height);
        }
        

        function getMoreInfo(idIs) {
            var prData = "" + $('#' + idIs).attr("data");
            var main = sessionStorage.getItem("main");
            var sub = sessionStorage.getItem("sub");
            var my_object = { "main": main, "sub": sub, "prData": prData}
            sessionStorage.setItem('my_item', JSON.stringify(my_object));
            console.log(prData);
            location.href = "sj3.html";
        }

        async function findMatchesCatg(searchValue) {
            langIs = localStorage.getItem("langID");
            $('#col1, #col2').empty();
            object = await getCategory(searchValue);
            console.log(object);
            counter = 0;
            for (var i in object) {
                subObj = object[i].translations;
                var idIs=object[i].id;
                for (var j in subObj) {
                    if (subObj[j]["language"].indexOf(langIs) > -1) {
                        counter = counter + 1;
                        var col = addToColumn();
                        var elem = '<span id=' + 'itm' + counter + ' onclick="getMoreInfo(this.id)"  class="colItem" data=' + idIs + '>' + subObj[j].first_name + " " + subObj[j].last_name + '</span>';
                        document.getElementById(col).innerHTML += elem;
                    }
                }
            }
            var table = document.getElementById("col1");
            height=table.offsetHeight +30;
            $('#splitCol').css("height", height);
        }

        function breadCrumbs() {
            $('body').delegate('#catgTitle', 'click', function () {
                location.href = "sj1.html";
            });

            $('body').delegate('#catgMain', 'click', function () {
                var main =  sessionStorage.getItem("main");
                var my_object_ = { "main": main, "sub": "" }
                localStorage.setItem('my_item_back', JSON.stringify(my_object_));
                fillColumns();
            });

        }

        $(function () {
            pickCSS();
            breadCrumbs();    
        });

    </script>
</head>

<body>
    <div class="header">
        <div class="headerWrapper">
            <div class="headerCont">
                <div class="langIcon" id="lang" onclick="pickLanguage()"></div>
                <div class="titleCont"><div class="mainTitle" id="hdTitle">מסע בין כוכבים</div></div>
                <div class="homeIcon" onclick="goHomePg()"></div>
            </div>
        </div>
        <div class="borderBtm"></div>
    </div>
    <div class="pageCont" id="sj2">
        <div class="pageWrapper">
            <div class="category">
                <span class="mainCat" id="catgTitle"></span>
                <span class="split" id="split1">&ensp;/&ensp;</span>
                <span class="mainCat" id="catgMain"></span>
                <span class="split" id="split2">&ensp;/&ensp;</span>
                <span class="subCat" id="catgSub"></span>
            </div>

            <div class="pageSubCont">
                <div class="pageSubWrapper">
                    <div class="searchCont"><input name="search" id="search" type="text" class="searchSec" placeholder="חפשו"  onchange="personSearh()"/></div>
                    <div class="table">
                        <div class="fstCol">
                            <div class="columnCont" id="col1">
                               
                            </div>
                        </div>
                        <div class="splitLine" id="splitCol"></div>
                        <div class="sndCol">
                            <div class="columnCont" id="col2">
                            
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>